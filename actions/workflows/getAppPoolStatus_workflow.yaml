version: 1.0
description: gets the health of all app pools

input:
  - host
tasks:
  getPoolInfo:
    action: bolt.command_run
    input:
      command: Get-IISAppPool
      nodes: <% ctx(host) %>
      private_key: /opt/stackstorm/configs/Macbook-pro.pem
      user: Administrator
      transport: ssh
    next:
      - when: <% succeeded() %>
        publish:
          - info: <% result().items[0].result.stdout %>
        do: tojson
  tojson:
    action: core.local
    input:
      cmd: echo "<% ctx(info) %>" | cut -d "----------" -f2 
    next:
      - when: <% succeeded() %>
        publish:
          - apppools: <% result().stdout %>
